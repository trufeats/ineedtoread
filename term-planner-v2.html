<!DOCTYPE html>
<html lang="en" class="light">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Term Planner V2</title>
<style>
:root{--ink:#e8ecef;--muted:#9aa4ad;--panel:#1a1d21;--panel-2:#20242a;--border:#6b7280;--barrier:#fff;--c-charcoal:#2f3136;--c-red:#e53935;--c-orange:#fb8c00;--c-yellow:#f6d743;--c-green:#43a047;--c-blue:#1e88e5;--c-purple:#8e24aa;--bg-light:#f5f7fb;--ink-light:#0e1116;--panel-light:#ffffff;--panel-2-light:#eef2f7;--border-light:#cfd6e0}
.light{--barrier:#000}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:linear-gradient(180deg,#0f1113 0%, #0b0c0e 60%) fixed}
.light body{color:var(--ink-light);background:linear-gradient(180deg,var(--bg-light) 0%, #ffffff 60%) fixed} .light .month{background:var(--panel-light);border-color:#e6ecf3} .light .month-head{background:var(--panel-2-light);border-color:#e6ecf3} .light .weekday-row{color:#5b6773} .light .day{background:linear-gradient(180deg,rgba(0,0,0,.02),rgba(0,0,0,0));border-top-color:#e9eef5;border-bottom-color:#e9eef5;border-left-color:#cfd6e0;border-right-color:#cfd6e0} .light .mini{border-color:#e0e6ef} .light .box{background:var(--panel-light);border-color:#e6ecf3} .light .box-header{background:var(--panel-2-light);border-color:#e6ecf3;color:var(--ink-light)} .light .label[placeholder]:empty::before{color:#6b7785}
.light .note-content,.light .box-body{color:var(--ink-light)} .light .pill{background:#fff;border-color:#e6ecf3;color:#2a313a} .light .btn{background:#fff;border-color:#e6ecf3;color:#2a313a} .light .legend-dot{box-shadow:0 0 0 1px rgba(0,0,0,.08) inset} .light .focus-toggle{width:18px;height:18px;border-radius:50%;border:2px solid currentColor;display:inline-flex;align-items:center;justify-content:center;cursor:pointer} .light .box-close{color:#2a313a} .light .resize-handle{background:#eef3f9;border-color:#d5dce6} .light ::selection{background:#8cb1ff;color:#0e1116} 
body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;color:var(--ink);background:linear-gradient(180deg,#0f1113 0%, #0b0c0e 60%) fixed}
.app-header{position:sticky;top:0;z-index:50;backdrop-filter:blur(6px);background-color:rgba(16,18,20,.7);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;gap:16px;padding:14px 18px}
.app-title{font-weight:700}
.hint{color:var(--muted);font-size:12px}
.pill{display:inline-flex;align-items:center;gap:8px;padding:6px 10px;border:1px solid rgba(255,255,255,.12);border-radius:999px;background:rgba(255,255,255,.03)}
.legend-dot{width:12px;height:12px;border-radius:50%;display:inline-block}
#calendarWrap{position:relative;width:100%}
#calendar{max-width:1400px;margin:16px auto 64px;padding:0 16px 80px}
.toolbar{margin:10px auto 6px;max-width:1400px;padding:0 16px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid rgba(255,255,255,.2);background:rgba(255,255,255,.06);color:var(--ink);padding:6px 10px;border-radius:10px;cursor:pointer}
.btn:hover{background:rgba(255,255,255,.09)}

.global-bar{max-width:340px;margin:0 auto 12px;padding:4px;display:none;border-radius:12px;}
.global-bar.open{display:block;animation:rainbow 8s linear infinite;background:linear-gradient(90deg,#e53935,#fb8c00,#f6d743,#43a047,#1e88e5,#8e24aa,#e53935);background-size:400% 400%;position:relative;}
.global-bar.open::after{content:"";position:absolute;inset:0;border-radius:12px;pointer-events:none;background:linear-gradient(120deg,transparent 35%,rgba(255,255,255,.25) 50%,transparent 65%);transform:translateX(-150%);animation:glimmer 3.2s linear infinite;animation-delay:var(--glimmer-phase,0s);}
.global-bar.open > .weekday-row,.global-bar.open > .days{background:var(--panel);border-radius:8px;}
.global-day .mini-grid{inset:6px;}
@keyframes rainbow{0%{background-position:0% 50%}100%{background-position:100% 50%}}
.help{margin:10px auto 18px;max-width:1400px;color:var(--muted);font-size:13px;padding:0 16px}
.months{display:grid;grid-template-columns:repeat(3,minmax(300px,1fr));gap:18px}
.month.hide{grid-template-rows:0fr}
.month.collapsed{overflow:hidden}
.month.collapsed .days{transition:max-height .35s ease,opacity .25s ease;max-height:0;opacity:0}
.month.expanded .days{transition:max-height .35s ease,opacity .25s ease;max-height:1200px;opacity:1}
.month.expanded{overflow:hidden}
.month{background:var(--panel);border:1px solid rgba(255,255,255,.08);border-radius:14px;overflow:hidden;display:flex;flex-direction:column}
.month-head{padding:10px 12px;font-weight:700;background:var(--panel-2);border-bottom:1px solid rgba(255,255,255,.06);display:flex;align-items:center;justify-content:space-between}
.month-controls{display:flex;align-items:center;gap:4px}
.month-toggle{background:transparent;border:none;color:inherit;cursor:pointer;font-size:16px}
.month-close{background:transparent;border:none;color:inherit;cursor:pointer;font-size:16px;display:none}
.weekday-row,.days{display:grid;grid-template-columns:repeat(7,1fr)}
.weekday-row{padding:6px 6px 8px;background:linear-gradient(180deg,rgba(255,255,255,.04),rgba(255,255,255,0));color:var(--muted);font-size:11px;gap:4px}
.day{position:relative;min-height:110px;border-top:1px solid rgba(255,255,255,.06);border-right:1px solid var(--border);border-left:1px solid var(--border);border-bottom:1px solid rgba(255,255,255,.06);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
.day.empty{background:transparent;border:none}
.day-number{position:absolute;top:4px;left:6px;font-size:12px;color:var(--muted);cursor:pointer}
.mini-grid{position:absolute;inset:22px 6px 6px 6px;display:grid;grid-template-columns:repeat(2,1fr);grid-template-rows:repeat(3,1fr);gap:4px}
.mini{position:relative;border:1px solid rgba(255,255,255,.12);border-radius:6px;background:transparent;cursor:pointer;transition:box-shadow .15s ease,transform .05s ease}
.mini:active{transform:scale(.98)}
.mini.charcoal{background:var(--c-charcoal)}.mini.red{background:var(--c-red)}.mini.orange{background:var(--c-orange)}.mini.yellow{background:var(--c-yellow)}.mini.green{background:var(--c-green)}.mini.blue{background:var(--c-blue)}.mini.purple{background:var(--c-purple)}.mini.blank{background:transparent}
.mini-char{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-weight:700;font-size:12px;color:#fff;user-select:text;pointer-events:none}
/* ensure legible mini text in light mode on blank cells */
.light .mini.blank .mini-char{color:#000}
/* hide caret everywhere by default; re-enable only where typing is intended */
*{caret-color:transparent}
.label,.box-title,.note-content,input,textarea,.iebox .box-body textarea,.mini.editing .mini-char{caret-color:auto}
.mini.editing{outline:2px dashed rgba(255,255,255,.4)}.mini.editing .mini-char{pointer-events:auto}
.day[data-left-barrier="1"]{border-left:4px solid var(--barrier)}
.day[data-right-barrier="1"]{border-right:4px solid var(--barrier)}
.barrier-handle{position:absolute;top:0;bottom:0;width:8px;cursor:col-resize;opacity:0;transition:opacity .15s ease}
.day:hover .barrier-handle{opacity:.9}
.barrier-handle.left{left:-4px}.barrier-handle.right{right:-4px}
.barrier-handle::after{content:"";position:absolute;top:0;bottom:0;left:2px;width:4px;background:linear-gradient(180deg,rgba(255,255,255,.25),rgba(255,255,255,0));border-radius:2px}
.day.hiddenOutside{visibility:hidden}
.day.holiday{background:var(--c-charcoal)!important;overflow:hidden}
.day.holiday .mini{background:var(--c-charcoal)!important}
.day.holiday .day-number{color:#fff}
.day.holiday .barrier-handle.left{left:0}
.day.holiday .barrier-handle.right{right:0}
.day.holiday::after{content:"";position:absolute;inset:0;background:linear-gradient(120deg,transparent 35%,rgba(255,255,255,.25) 50%,transparent 65%);transform:translateX(-150%);animation:glimmer 3.2s linear infinite;animation-delay:var(--glimmer-phase,0s);pointer-events:none}
@keyframes glimmer{0%{transform:translateX(-150%)}100%{transform:translateX(150%)}}
.day.holiday.sync2::after{animation-name:glimmer2}
@keyframes glimmer2{0%{transform:translateX(-150%)}100%{transform:translateX(150%)}}
.box{position:absolute;z-index:40;width:280px;min-width:240px;min-height:140px;color:var(--ink);background:var(--panel);border:1px solid rgba(255,255,255,.12);border-radius:14px;box-shadow:0 6px 20px rgba(0,0,0,.4);overflow:hidden;user-select:none;display:flex;flex-direction:column}
.box-header{display:flex;align-items:center;gap:10px;padding:10px;background:var(--panel-2);border-bottom:1px solid rgba(255,255,255,.08);cursor:grab}
.box-title{flex:1;outline:none;font-weight:700;color:inherit}
.box-title[placeholder]:empty::before{content:attr(placeholder);color:var(--muted)}
.focus-toggle{width:18px;height:18px;border-radius:50%;border:2px solid var(--ink);display:inline-flex;align-items:center;justify-content:center;cursor:pointer}
.focus-toggle.on{background:currentColor}
.box-body{padding:10px;overflow:auto;flex:1}
.counts{display:flex;flex-direction:column;gap:6px}
.count-row{display:grid;grid-template-columns:18px 1fr auto;align-items:center;gap:8px;padding:6px 8px;border:1px solid rgba(255,255,255,.08);border-radius:8px;background:rgba(255,255,255,.02)}
.swatch{width:14px;height:14px;border-radius:4px}
.label{outline:none;min-width:40px}
.label[placeholder]:empty::before{content:attr(placeholder);color:var(--muted)}
.box-close{background:transparent;border:none;color:var(--ink);font-size:16px;line-height:1;cursor:pointer;opacity:.85;padding:2px 6px}
.box-close:hover{opacity:1}
.resize-handle{position:absolute;width:14px;height:14px;right:6px;bottom:6px;cursor:se-resize;background:rgba(255,255,255,.12);border:1px solid rgba(255,255,255,.25);border-radius:3px}
.resize-handle::after{content:"";position:absolute;right:2px;bottom:2px;width:8px;height:8px;border-right:2px solid rgba(255,255,255,.6);border-bottom:2px solid rgba(255,255,255,.6)}
.term-chip{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;background:rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.12);font-size:12px}
.note-chip::before{content:"📝 "}

.iebox .box-header{cursor:grab}
.iebox .box-body textarea{width:100%;height:140px;background:transparent;border:1px solid rgba(255,255,255,.15);color:var(--ink);border-radius:8px;padding:8px;resize:vertical}
.light .iebox .box-body textarea{color:var(--ink-light);background:#fff;border-color:#d5dce6}
.footer-spacer{height:40px}
::selection{background:#2d61ff;color:#fff}
@media(max-width:1100px){.months{grid-template-columns:repeat(2,minmax(260px,1fr))}}
@media(max-width:780px){.months{grid-template-columns:1fr}}
</style>
</head>
<body>
<header class="app-header">
  <div class="app-title">Term Planner V2</div>
  
</header>

<!-- Toolbar (Import/Export ideas not implemented yet) -->
<div class="toolbar">
  <button id="addNoteBtn" class="btn" title="New note">📝 Note</button>
  <button id="themeToggle" class="btn" title="Toggle light/dark">☀️ / 🌙</button>
  
  <button id="ieToggle" class="btn" title="Import / Export">⇄ Import/Export</button>
  
</div>

  <div class="toolbar" style="margin-top:0">
    <button id="prevMonthBtn" class="btn" title="Add previous month">&laquo; Prev</button>
    <button id="nextMonthBtn" class="btn" title="Add next month">Next &raquo;</button>
    <button id="globalToggle" class="btn" title="Apply to all weekdays">Global</button>
  </div>
  <div id="globalBar" class="global-bar">
    <div class="weekday-row"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
    <div class="days" id="globalDays"></div>
  </div>
  <div class="help">
  <div class="pill" style="gap:10px;flex-wrap:wrap">
    <span class="legend-dot" style="background:var(--c-charcoal)"></span>Charcoal
    <span class="legend-dot" style="background:var(--c-red)"></span>Red
    <span class="legend-dot" style="background:var(--c-orange)"></span>Orange
    <span class="legend-dot" style="background:var(--c-yellow)"></span>Yellow
    <span class="legend-dot" style="background:var(--c-green)"></span>Green
    <span class="legend-dot" style="background:var(--c-blue)"></span>Blue
    <span class="legend-dot" style="background:var(--c-purple)"></span>Purple
    <span class="legend-dot" style="background:transparent;border:1px dashed rgba(255,255,255,.35)"></span>Blank
  </div>
  <div class="pill" id="termsLegend" style="gap:8px;flex-wrap:wrap" title="Term titles">No terms yet</div>
  <div class="pill" id="notesLegend" style="gap:8px;flex-wrap:wrap" title="Notes">No notes yet</div>
</div>

<div id="calendarWrap">
  <div id="calendar"><div class="months" id="months"></div></div>
</div>
<div class="footer-spacer"></div>

<script>
(()=>{
const BUILD_START={y:2025,m:0};
const BUILD_END={y:2035,m:11};
const INITIAL_KEY='2026-0';
const COLORS=[{key:'charcoal',name:'Charcoal',css:'charcoal'},{key:'red',name:'Red',css:'red'},{key:'orange',name:'Orange',css:'orange'},{key:'yellow',name:'Yellow',css:'yellow'},{key:'green',name:'Green',css:'green'},{key:'blue',name:'Blue',css:'blue'},{key:'purple',name:'Purple',css:'purple'},{key:'blank',name:'Blank',css:'blank'}];
const colorLabels=Object.fromEntries(COLORS.map(c=>[c.key,c.name]));
const blankIndex=COLORS.findIndex(c=>c.key==='blank');
const globalTemplate=Array.from({length:7},()=>Array(6).fill(blankIndex));
const globalLetters=Array.from({length:7},()=>Array(6).fill(""));
const days=[],dayEls=[],barriers=new Set(),barrierBoxes=new Map(),notesBoxes=new Map();
let noteSeq=1,activeFocusPos=null,tHeld=false;
const monthsRoot=document.getElementById('months'),wrap=document.getElementById('calendarWrap');
const monthSections=new Map(),monthOrder=[];
let shownStartIdx=0,shownEndIdx=0;
let prevMonthBtn=null,nextMonthBtn=null;
const GLIMMER_PERIOD=3.2,glimmerBase=performance.now(); let glimmerFlip=false;

function buildDays(){
  const s=new Date(Date.UTC(BUILD_START.y,BUILD_START.m,1));
  const e=new Date(Date.UTC(BUILD_END.y,BUILD_END.m+1,0));
  for(let d=new Date(s); d<=e; d.setUTCDate(d.getUTCDate()+1)){
    days.push({
      date:new Date(d),
      monthIndex:d.getUTCMonth(),
      year:d.getUTCFullYear(),
      dayOfMonth:d.getUTCDate(),
      weekDay:d.getUTCDay(),
      grid:Array(6).fill(blankIndex),
      letters:["","","","","",""],
      isHoliday:false
    });
  }
}
function monthHead(y,m){
  return new Date(Date.UTC(y,m,1)).toLocaleString('en-US',{month:'long'})+' '+y;
}
function buildMonthShells(){
  const group=new Map();
  for(const d of days){
    const key=d.year+'-'+d.monthIndex; if(!group.has(key)) group.set(key,[]); group.get(key).push(d);
  }
  const ordered=[...group.keys()].sort((a,b)=>{const [ya,ma]=a.split('-').map(Number),[yb,mb]=b.split('-').map(Number); return (ya-yb)||(ma-mb);});
  for(const key of ordered){
    const [y,m]=key.split('-').map(Number);
    const sec=document.createElement('section'); sec.className='month';
    sec.dataset.month=String(m); sec.dataset.year=String(y);
    sec.style.display='none';
    sec.innerHTML=`<div class="month-head"><span>${monthHead(y,m)}</span><div class="month-controls"><button class="month-toggle" title="Collapse month">−</button><button class="month-close" title="Remove month">×</button></div></div>
<div class="weekday-row"><div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div></div>
<div class="days" id="month-days-${y}-${m}"></div>`;
    const toggle=sec.querySelector('.month-toggle');
    toggle.addEventListener('click',()=>{const collapsed=sec.classList.contains('collapsed');if(collapsed){sec.classList.remove('collapsed');sec.classList.add('expanded');toggle.textContent='−';}else{sec.classList.remove('expanded');sec.classList.add('collapsed');toggle.textContent='+';}});
    const closeBtn=sec.querySelector('.month-close');
    closeBtn.addEventListener('click',()=>{const idx=monthOrder.indexOf(key);closeMonthAt(idx);});
    monthsRoot.appendChild(sec);
    monthSections.set(key,sec);
    monthOrder.push(key);
    const md=group.get(key), grid=sec.querySelector('.days');
    const fw=md[0].weekDay;
    for(let i=0;i<fw;i++){ const e=document.createElement('div'); e.className='day empty'; grid.appendChild(e); }
  }
}
function renderDayCells(){
  let gi=0;
  const group=new Map();
  for(const d of days){ const key=d.year+'-'+d.monthIndex; if(!group.has(key)) group.set(key,[]); group.get(key).push(d); }
  const ordered=[...group.keys()].sort((a,b)=>{const [ya,ma]=a.split('-').map(Number),[yb,mb]=b.split('-').map(Number); return (ya-yb)||(ma-mb);});
  for(const key of ordered){
    const [y,m]=key.split('-').map(Number);
    const md=group.get(key), grid=document.getElementById(`month-days-${y}-${m}`);
    for(const d of md){
      const day=document.createElement('div'); day.className='day'; day.dataset.index=gi;
      day.innerHTML=`<div class="day-number">${d.dayOfMonth}</div>
<div class="mini-grid">${Array.from({length:6}).map((_,i)=>`<div class=\"mini blank\" data-mini=\"${i}\"><span class=\"mini-char\"></span></div>`).join('')}</div>
<div class="barrier-handle left" data-edge="left" title="Toggle barrier (left)"></div>
<div class="barrier-handle right" data-edge="right" title="Toggle barrier (right)"></div>`;
      day.querySelector('.mini-grid').addEventListener('click',ev=>{ const mini=ev.target.closest('.mini'); if(!mini) return; const i=+mini.dataset.mini; if(tHeld){ startMiniEdit(d,i,mini); return } const cur=d.grid[i], next=ev.shiftKey?((cur-1+COLORS.length)%COLORS.length):((cur+1)%COLORS.length); d.grid[i]=next; applyMiniColor(mini,next); recalcAllBoxes(); });
      day.querySelectorAll('.barrier-handle').forEach(h=>h.addEventListener('click',ev=>{ ev.stopPropagation(); const edge=h.dataset.edge, idx=+day.dataset.index, pos=(edge==='left')?idx:(idx+1); toggleBarrier(pos);}));
      day.querySelector('.day-number').addEventListener('click',()=>openBoxForDay(+day.dataset.index));
      day.addEventListener('click',ev=>{ if(ev.target.closest('.mini')||ev.target.closest('.barrier-handle')||ev.target.closest('.day-number')) return; toggleHoliday(+day.dataset.index); });
      day.querySelectorAll('.mini').forEach((mini,i)=>{ applyMiniColor(mini,d.grid[i]); applyMiniLetter(mini,d.letters[i]); });
      grid.appendChild(day); dayEls.push(day); gi++;
    }
    const rem=grid.children.length%7; if(rem){ for(let i=0;i<7-rem;i++){ const e=document.createElement('div'); e.className='day empty'; grid.appendChild(e); } }
  }
}
function dayIsVisible(i){const d=days[i];const key=d.year+'-'+d.monthIndex;const sec=monthSections.get(key);return sec&&sec.style.display!=='none'&&!sec.classList.contains('collapsed');}
function applyGlobalColor(wd,miniIdx,colorIdx){for(let i=0;i<days.length;i++){const d=days[i];if(d.weekDay===wd&&!d.isHoliday&&dayIsVisible(i)){d.grid[miniIdx]=colorIdx;const el=dayEls[i].querySelectorAll('.mini')[miniIdx];applyMiniColor(el,colorIdx);}}recalcAllBoxes();}
function applyGlobalLetter(wd,miniIdx,letter){for(let i=0;i<days.length;i++){const d=days[i];if(d.weekDay===wd&&!d.isHoliday&&dayIsVisible(i)){d.letters[miniIdx]=letter;const el=dayEls[i].querySelectorAll('.mini')[miniIdx];applyMiniLetter(el,letter);}}}
function buildGlobalWeek(){const container=document.getElementById('globalDays');if(!container)return;const order=[0,1,2,3,4,5,6];container.innerHTML='';for(const wd of order){const day=document.createElement('div');day.className='day global-day';day.dataset.wd=wd;day.innerHTML=`<div class="mini-grid">${Array.from({length:6}).map((_,i)=>`<div class="mini blank" data-mini="${i}"><span class="mini-char"></span></div>`).join('')}</div>`;day.querySelector('.mini-grid').addEventListener('click',ev=>{const mini=ev.target.closest('.mini');if(!mini)return;const i=+mini.dataset.mini;if(tHeld){startGlobalMiniEdit(wd,i,mini);return}const cur=globalTemplate[wd][i];const next=ev.shiftKey?((cur-1+COLORS.length)%COLORS.length):((cur+1)%COLORS.length);globalTemplate[wd][i]=next;applyMiniColor(mini,next);applyGlobalColor(wd,i,next);});day.querySelectorAll('.mini').forEach((mini,i)=>{applyMiniColor(mini,globalTemplate[wd][i]);applyMiniLetter(mini,globalLetters[wd][i]);});container.appendChild(day);}}
function globalTemplateEmpty(){for(let wd=0;wd<7;wd++){for(let i=0;i<6;i++){if(globalTemplate[wd][i]!==blankIndex)return false;if(globalLetters[wd][i])return false;}}return true;}
function resetGlobalTemplate(){for(let wd=0;wd<7;wd++){for(let i=0;i<6;i++){globalTemplate[wd][i]=blankIndex;globalLetters[wd][i]='';}}document.querySelectorAll('#globalDays .mini').forEach(m=>{applyMiniColor(m,blankIndex);applyMiniLetter(m,'');});}
function startGlobalMiniEdit(wd,idx,el){const s=el.querySelector('.mini-char');if(!s)return;el.classList.add('editing');s.contentEditable='true';s.focus();const sel=window.getSelection(),r=document.createRange();r.selectNodeContents(s);r.collapse(false);sel.removeAllRanges();sel.addRange(r);function end(){s.contentEditable='false';el.classList.remove('editing');globalLetters[wd][idx]=(s.textContent||'').slice(0,1);applyMiniLetter(el,globalLetters[wd][idx]);applyGlobalLetter(wd,idx,globalLetters[wd][idx]);s.removeEventListener('input',onI);s.removeEventListener('keydown',onK);s.removeEventListener('blur',end)}function onI(){if(s.textContent&&s.textContent.length>1){s.textContent=s.textContent.slice(0,1);const rr=document.createRange();rr.selectNodeContents(s);rr.collapse(false);const ss=window.getSelection();ss.removeAllRanges();ss.addRange(rr)}}function onK(e){if(e.key==='Enter'||e.key==='Escape'){e.preventDefault();end()}}s.addEventListener('input',onI);s.addEventListener('keydown',onK);s.addEventListener('blur',end)}
function applyMiniColor(el,idx){el.className='mini '+COLORS[idx].css}
function applyMiniLetter(el,t){const s=el.querySelector('.mini-char');if(s)s.textContent=(t||'').slice(0,1)}
function startMiniEdit(d,idx,el){const s=el.querySelector('.mini-char');if(!s)return;el.classList.add('editing');s.contentEditable='true';s.focus();const sel=window.getSelection(),r=document.createRange();r.selectNodeContents(s);r.collapse(false);sel.removeAllRanges();sel.addRange(r);function end(){s.contentEditable='false';el.classList.remove('editing');d.letters[idx]=(s.textContent||'').slice(0,1);applyMiniLetter(el,d.letters[idx]);s.removeEventListener('input',onI);s.removeEventListener('keydown',onK);s.removeEventListener('blur',end)}function onI(){if(s.textContent&&s.textContent.length>1){s.textContent=s.textContent.slice(0,1);const rr=document.createRange();rr.selectNodeContents(s);rr.collapse(false);const ss=window.getSelection();ss.removeAllRanges();ss.addRange(rr)}}function onK(e){if(e.key==='Enter'||e.key==='Escape'){e.preventDefault();end()}}s.addEventListener('input',onI);s.addEventListener('keydown',onK);s.addEventListener('blur',end)}
function updateDayBorders(pos){const L=pos-1,R=pos;if(dayEls[L]){barriers.has(pos)?dayEls[L].dataset.rightBarrier='1':delete dayEls[L].dataset.rightBarrier}if(dayEls[R]){barriers.has(pos)?dayEls[R].dataset.leftBarrier='1':delete dayEls[R].dataset.leftBarrier}}
function nearestPrevBarrier(pos){let prev=0;for(const p of Array.from(barriers).sort((a,b)=>a-b)){if(p<pos)prev=p;else break}return prev}
function segmentFor(pos){const start=nearestPrevBarrier(pos),end=pos-1;return{start,end}}
function countsInRange(start,end){
  const counts=Object.fromEntries(COLORS.map(c=>[c.key,0]));
  for(let i=start;i<=end;i++){
    const d=days[i];
    if(d.isHoliday){ counts['charcoal']++; continue; }
    const set=new Set();
    for(const idx of d.grid){
      const key=COLORS[idx].key;
      if(key!=='blank') set.add(key);
    }
    for(const k of set) counts[k]++;
  }
  return counts;
}
function nonZeroSorted(counts){const order=Object.fromEntries(COLORS.map((c,i)=>[c.key,i]));return Object.entries(counts).filter(([,v])=>v>0).sort((a,b)=>order[a[0]]-order[b[0]])}
function getCSSVar(key){const s=getComputedStyle(document.documentElement);return({charcoal:'--c-charcoal',red:'--c-red',orange:'--c-orange',yellow:'--c-yellow',green:'--c-green',blue:'--c-blue',purple:'--c-purple'}[key]||'')?s.getPropertyValue({charcoal:'--c-charcoal',red:'--c-red',orange:'--c-orange',yellow:'--c-yellow',green:'--c-green',blue:'--c-blue',purple:'--c-purple'}[key]):'transparent'}
function buildCountsList(counts){const wrap=document.createElement('div');wrap.className='counts';const arr=nonZeroSorted(counts);if(arr.length===0){const none=document.createElement('div');none.className='hint';none.textContent='No colored cells in this term yet';wrap.appendChild(none);return wrap}for(const [key,val] of arr){const row=document.createElement('div');row.className='count-row';const sw=document.createElement('div');sw.className='swatch';sw.style.background=getCSSVar(key);const label=document.createElement('div');label.className='label';label.contentEditable='true';label.dataset.colorKey=key;label.textContent=colorLabels[key];label.setAttribute('placeholder',key);const num=document.createElement('div');num.textContent=val;label.addEventListener('input',()=>{colorLabels[key]=label.textContent||'';document.querySelectorAll(`.label[data-color-key="${key}"]`).forEach(el=>{if(el!==label)el.textContent=colorLabels[key]})});row.appendChild(sw);row.appendChild(label);row.appendChild(num);wrap.appendChild(row)}return wrap}
function createBoxForBarrier(pos){const {start,end}=segmentFor(pos),box=document.createElement('article');box.className='box';box.dataset.pos=String(pos);const header=document.createElement('div');header.className='box-header';const focus=document.createElement('div');focus.className='focus-toggle';const title=document.createElement('div');title.className='box-title';title.contentEditable='true';title.setAttribute('placeholder','Term title');const close=document.createElement('button');close.className='box-close';close.innerHTML='&times;';header.appendChild(focus);header.appendChild(title);header.appendChild(close);const body=document.createElement('div');body.className='box-body';body.appendChild(buildCountsList(countsInRange(start,end)));box.appendChild(header);box.appendChild(body);const rsH=document.createElement('div');rsH.className='resize-handle';box.appendChild(rsH);
// drag
let drag={on:false,x:0,y:0,l:0,t:0};header.addEventListener('mousedown',e=>{drag.on=true;box.style.cursor='grabbing';drag.x=e.clientX;drag.y=e.clientY;const r=box.getBoundingClientRect(),wr=wrap.getBoundingClientRect();drag.l=r.left-wr.left;drag.t=r.top-wr.top;document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp,{once:true})});box.addEventListener('mousedown',e=>{if(!e.shiftKey||e.target.closest('.resize-handle'))return;drag.on=true;box.style.cursor='grabbing';drag.x=e.clientX;drag.y=e.clientY;const r=box.getBoundingClientRect(),wr=wrap.getBoundingClientRect();drag.l=r.left-wr.left;drag.t=r.top-wr.top;document.addEventListener('mousemove',onMove);document.addEventListener('mouseup',onUp,{once:true})});function onMove(e){if(!drag.on)return;box.style.left=(drag.l+e.clientX-drag.x)+'px';box.style.top=(drag.t+e.clientY-drag.y)+'px';const b=barrierBoxes.get(pos);if(b)b.isDragged=true}function onUp(){drag.on=false;box.style.cursor='';document.removeEventListener('mousemove',onMove)}
// focus
focus.addEventListener('click',()=>{const b=barrierBoxes.get(pos);if(!b)return;b.focusOn?clearFocus():setFocus(pos)});
// title
title.addEventListener('input',()=>{const b=barrierBoxes.get(pos);if(b)b.title=title.textContent||'';refreshTermsLegend()});
// close
close.addEventListener('click',()=>{const b=barrierBoxes.get(pos);if(b&&b.focusOn)clearFocus();box.style.display='none';if(b)b.closed=true});
// resize
let rs={on:false,x:0,y:0,w:0,h:0};rsH.addEventListener('mousedown',e=>{e.preventDefault();rs.on=true;rs.x=e.clientX;rs.y=e.clientY;const r=box.getBoundingClientRect();rs.w=r.width;rs.h=r.height;document.addEventListener('mousemove',onRM);document.addEventListener('mouseup',onRU,{once:true})});function onRM(e){if(!rs.on)return;box.style.width=Math.max(240,rs.w+e.clientX-rs.x)+'px';box.style.height=Math.max(140,rs.h+e.clientY-rs.y)+'px'}function onRU(){rs.on=false;document.removeEventListener('mousemove',onRM)}wrap.appendChild(box);return{el:box,title:'',isDragged:false,focusOn:false,closed:false}}
function toggleBarrier(pos){if(barriers.has(pos)){barriers.delete(pos);updateDayBorders(pos);const b=barrierBoxes.get(pos);if(b){if(b.focusOn)clearFocus();b.el.remove();barrierBoxes.delete(pos)}recalcAllBoxes();refreshTermsLegend()}else{barriers.add(pos);updateDayBorders(pos);const box=createBoxForBarrier(pos);barrierBoxes.set(pos,box);recalcAllBoxes();positionBox(pos);refreshTermsLegend()}}
function recalcAllBoxes(){for(const [pos,b] of barrierBoxes){const {start,end}=segmentFor(pos),body=b.el.querySelector('.box-body');body.innerHTML='';body.appendChild(buildCountsList(countsInRange(start,end)))} }
function positionBox(pos){const b=barrierBoxes.get(pos);if(!b||b.isDragged)return;const {start,end}=segmentFor(pos),mid=Math.floor((start+end)/2),el=dayEls[mid]||dayEls[end]||dayEls[start];if(!el)return;const wr=wrap.getBoundingClientRect(),r=el.getBoundingClientRect();requestAnimationFrame(()=>{const bb=b.el.getBoundingClientRect();b.el.style.left=Math.max(8,(r.right-wr.left)+16)+'px';b.el.style.top=Math.max(8,(r.top-wr.top)+(r.height/2)-(bb.height/2))+'px'})}
function setFocus(pos){clearFocus();const b=barrierBoxes.get(pos);if(!b)return;const {start,end}=segmentFor(pos);for(let i=0;i<days.length;i++){if(i<start||i>end)dayEls[i].classList.add('hiddenOutside')}b.focusOn=true;activeFocusPos=pos;document.querySelectorAll('.focus-toggle').forEach(x=>x.classList.remove('on'));b.el.querySelector('.focus-toggle').classList.add('on')}
function clearFocus(){for(const el of dayEls)el.classList.remove('hiddenOutside');if(activeFocusPos!=null){const b=barrierBoxes.get(activeFocusPos);if(b){b.focusOn=false;const t=b.el.querySelector('.focus-toggle');if(t)t.classList.remove('on')}}activeFocusPos=null}
function nextBarrierAfter(idx){const s=[...barriers].sort((a,b)=>a-b);for(const p of s)if(p>idx)return p;return null}
function openBoxForDay(i){const pos=nextBarrierAfter(i);if(!pos)return;const b=barrierBoxes.get(pos);if(!b)return;b.el.style.display='';b.closed=false;positionBox(pos)}
function toggleHoliday(i){const d=days[i],el=dayEls[i],b=COLORS.findIndex(c=>c.key==='blank'),ch=COLORS.findIndex(c=>c.key==='charcoal');if(!d||!el)return;if(!d.isHoliday){d.isHoliday=true;d.grid=[ch,ch,ch,ch,ch,ch];d.letters=["","","","","","" ];el.classList.add('holiday');el.querySelectorAll('.mini').forEach(m=>{applyMiniColor(m,ch);applyMiniLetter(m,"")});}
else{d.isHoliday=false;d.grid=[b,b,b,b,b,b];d.letters=["","","","","","" ];el.classList.remove('holiday');el.querySelectorAll('.mini').forEach(m=>{applyMiniColor(m,b);applyMiniLetter(m,"")});}
recalcAllBoxes();syncAllGlimmers();}
function refreshTermsLegend(){const el=document.getElementById('termsLegend');const list=[...barrierBoxes.entries()].sort((a,b)=>a[0]-b[0]);el.innerHTML=list.length?list.map(([pos,b])=>`<span class="term-chip" data-pos="${pos}">${(b.title||'').trim()||'Untitled Term'}</span>`).join(' '):'No terms yet'}
function createNoteBox(id){const box=document.createElement('article');box.className='box note';box.dataset.noteId=String(id);const header=document.createElement('div');header.className='box-header';const title=document.createElement('div');title.className='box-title';title.contentEditable='true';title.setAttribute('placeholder','Note title');const close=document.createElement('button');close.className='box-close';close.innerHTML='&times;';header.appendChild(title);header.appendChild(close);const body=document.createElement('div');body.className='box-body note-content';body.contentEditable='true';box.appendChild(header);box.appendChild(body);box.style.left=(16+(id-1)*24)+'px';box.style.top=(100+(id-1)*12)+'px';let drag={on:false,x:0,y:0,l:0,t:0};header.addEventListener('mousedown',e=>{drag.on=true;box.style.cursor='grabbing';drag.x=e.clientX;drag.y=e.clientY;const r=box.getBoundingClientRect(),wr=wrap.getBoundingClientRect();drag.l=r.left-wr.left;drag.t=r.top-wr.top;document.addEventListener('mousemove',onM);document.addEventListener('mouseup',onU,{once:true})});box.addEventListener('mousedown',e=>{if(!e.shiftKey||e.target.closest('.resize-handle'))return;drag.on=true;box.style.cursor='grabbing';drag.x=e.clientX;drag.y=e.clientY;const r=box.getBoundingClientRect(),wr=wrap.getBoundingClientRect();drag.l=r.left-wr.left;drag.t=r.top-wr.top;document.addEventListener('mousemove',onM);document.addEventListener('mouseup',onU,{once:true})});function onM(e){if(!drag.on)return;box.style.left=(drag.l+e.clientX-drag.x)+'px';box.style.top=(drag.t+e.clientY-drag.y)+'px'}function onU(){drag.on=false;box.style.cursor='';document.removeEventListener('mousemove',onM)}const rsH=document.createElement('div');rsH.className='resize-handle';box.appendChild(rsH);let rs={on:false,x:0,y:0,w:0,h:0};rsH.addEventListener('mousedown',e=>{e.preventDefault();rs.on=true;rs.x=e.clientX;rs.y=e.clientY;const r=box.getBoundingClientRect();rs.w=r.width;rs.h=r.height;document.addEventListener('mousemove',onRM);document.addEventListener('mouseup',onRU,{once:true})});function onRM(e){if(!rs.on)return;box.style.width=Math.max(240,rs.w+e.clientX-rs.x)+'px';box.style.height=Math.max(140,rs.h+e.clientY-rs.y)+'px'}function onRU(){rs.on=false;document.removeEventListener('mousemove',onRM)}close.addEventListener('click',()=>{box.style.display='none';const b=notesBoxes.get(id);if(b)b.closed=true});title.addEventListener('input',()=>{const b=notesBoxes.get(id);if(b)b.title=title.textContent||'';refreshNotesLegend()});wrap.appendChild(box);return{el:box,title:'',closed:false}}
function refreshNotesLegend(){
  const el=document.getElementById('notesLegend');
  const list=[...notesBoxes.entries()].sort((a,b)=>a[0]-b[0]);
  el.innerHTML=list.length?list.map(([id,b])=>`<span class="term-chip note-chip" data-note-id="${id}">${(b.title||'').trim()||('Note '+id)}</span>`).join(' '):'No notes yet';
}
function deleteNote(id){const b=notesBoxes.get(id);if(!b)return;b.el.remove();notesBoxes.delete(id);refreshNotesLegend();}
function revealMonthAt(idx){const key=monthOrder[idx];const sec=monthSections.get(key);sec.style.display='';sec.classList.add('collapsed');const btn=sec.querySelector('.month-toggle');if(btn)btn.textContent='−';requestAnimationFrame(()=>{sec.classList.remove('collapsed');sec.classList.add('expanded');});}
function showPrevMonth(){if(shownStartIdx>0){shownStartIdx--;revealMonthAt(shownStartIdx);updateMonthButtons();updateMonthClosers();}}
function showNextMonth(){if(shownEndIdx<monthOrder.length-1){shownEndIdx++;revealMonthAt(shownEndIdx);updateMonthButtons();updateMonthClosers();}}
function updateMonthButtons(){if(prevMonthBtn)prevMonthBtn.disabled=(shownStartIdx===0);if(nextMonthBtn)nextMonthBtn.disabled=(shownEndIdx===monthOrder.length-1);}
function closeMonthAt(idx){if(shownEndIdx===shownStartIdx)return;const key=monthOrder[idx];const sec=monthSections.get(key);if(sec)sec.style.display='none';if(idx===shownStartIdx)shownStartIdx++;if(idx===shownEndIdx)shownEndIdx--;updateMonthButtons();updateMonthClosers();}
function updateMonthClosers(){monthOrder.forEach((key,idx)=>{const sec=monthSections.get(key);if(!sec)return;const btn=sec.querySelector('.month-close');if(!btn)return;const visible=idx>=shownStartIdx&&idx<=shownEndIdx&&sec.style.display!== 'none';const allow=visible&&(idx===shownStartIdx||idx===shownEndIdx)&&(shownEndIdx>shownStartIdx);btn.style.display=allow?'':'none';});}
let helpEl=null;function createHelp(){if(helpEl)return helpEl;const box=document.createElement('article');box.className='box helpbox';const head=document.createElement('div');head.className='box-header';const tt=document.createElement('div');tt.className='box-title';tt.textContent='Keyboard & Mouse';const x=document.createElement('button');x.className='box-close';x.innerHTML='&times;';head.appendChild(tt);head.appendChild(x);const body=document.createElement('div');body.className='box-body';body.innerHTML='<div>• Click mini: next color · Shift+Click: prev</div><div>• Hold “t” + click mini: type 1 char</div><div>• Click day background: toggle holiday</div><div>• Click day number: open term box</div><div>• Click left/right edge: toggle barrier</div><div>• Drag term boxes; circle = focus</div><div>• Legend chips: toggle term/note</div><div>• Shift+Click note chip: delete note</div><div>• Esc cascade: focus→clear minis; else close boxes → reset minis → remove barriers</div>';box.appendChild(head);box.appendChild(body);box.style.left='16px';box.style.top='120px';x.addEventListener('click',()=>box.style.display='none');wrap.appendChild(box);helpEl=box;return box;}

// Import/Export panel + codec helpers (stateful)
let ieEl=null;function createIE(){if(ieEl)return ieEl;const box=document.createElement('article');box.className='box iebox';const head=document.createElement('div');head.className='box-header';const tt=document.createElement('div');tt.className='box-title';tt.textContent='Import / Export';const x=document.createElement('button');x.className='box-close';x.innerHTML='&times;';head.appendChild(tt);head.appendChild(x);const body=document.createElement('div');body.className='box-body';body.innerHTML='<div class="hint" style="margin-bottom:8px">Export copies current state. Import replaces everything.</div><textarea id="ieText" placeholder="Paste code here to import..."></textarea><div style="display:flex;gap:8px;margin-top:8px"><button id="doExport" class="btn">Export</button><button id="doImport" class="btn">Import</button></div>';box.appendChild(head);box.appendChild(body);box.style.right='16px';box.style.top='120px';box.style.left='';wrap.appendChild(box);
// drag
let dg={on:false,x:0,y:0,l:0,t:0};
head.addEventListener('mousedown',e=>{dg.on=true;box.style.cursor='grabbing';dg.x=e.clientX;dg.y=e.clientY;const r=box.getBoundingClientRect(),wr=wrap.getBoundingClientRect();dg.l=r.left-wr.left;dg.t=r.top-wr.top;document.addEventListener('mousemove',mv);document.addEventListener('mouseup',up,{once:true})});
function mv(e){if(!dg.on)return;box.style.left=(dg.l+e.clientX-dg.x)+'px';box.style.top=(dg.t+e.clientY-dg.y)+'px'}
function up(){dg.on=false;box.style.cursor='';document.removeEventListener('mousemove',mv)}
x.addEventListener('click',()=>box.style.display='none');
const ta=box.querySelector('#ieText');box.querySelector('#doExport').addEventListener('click',async()=>{try{const s=await exportState();ta.value=s;ta.focus();ta.select();}catch(e){ta.value='EXPORT ERROR: '+e}});box.querySelector('#doImport').addEventListener('click',async()=>{const s=ta.value.trim();if(!s)return;try{await importState(s);ta.blur();}catch(e){alert('Import failed: '+e)}});ieEl=box;return box;}
function epochDays(d){return Math.floor(d.getTime()/86400000)}
function b64(u){return btoa(String.fromCharCode.apply(null,u))}
function ub64(s){const b=atob(s);const a=new Uint8Array(b.length);for(let i=0;i<b.length;i++)a[i]=b.charCodeAt(i);return a}
function ve(n){const a=[];while(n>127){a.push((n&127)|128);n>>>=7}a.push(n);return a}
function vd(u,i){let n=0,s=0,b;do{b=u[i++];n|=(b&127)<<s;s+=7}while(b&128);return[n,i]}
function packDays(){const start=epochDays(days[0].date),len=days.length;const head=[...ve(start),...ve(len)];let cur=0,nb=0,out=[];const pb=b=>{cur|=(b&1)<<nb;nb++;if(nb===8){out.push(cur);cur=0;nb=0}};const pb3=v=>{pb(v&1);pb((v>>1)&1);pb((v>>2)&1)};for(const d of days){pb(d.isHoliday?1:0);for(let i=0;i<6;i++)pb3(d.grid[i]|0)}if(nb)out.push(cur);return new Uint8Array([...head,...out])}
function applyDayVisual(i){const d=days[i],el=dayEls[i];if(!el)return;el.classList.toggle('holiday',!!d.isHoliday);for(let k=0;k<6;k++){const mini=el.querySelectorAll('.mini')[k];applyMiniColor(mini,d.grid[k]|0);applyMiniLetter(mini,d.letters[k]||'')}}
function unpackDays(U){let i=0;let [start,i2]=vd(U,0);let [len,i3]=vd(U,i2);i=i3;const map=new Map();for(let j=0;j<days.length;j++)map.set(epochDays(days[j].date),j);let byteIdx=i,bit=0,cur=U[byteIdx]||0;const gb=()=>{const v=(cur>>bit)&1;bit++;if(bit===8){bit=0;byteIdx++;cur=U[byteIdx]||0}return v};for(let k=0;k<len;k++){const ep=start+k,di=map.get(ep);const hol=gb()?1:0;let arr=[0,0,0,0,0,0];for(let m=0;m<6;m++){let v=gb()|(gb()<<1)|(gb()<<2);arr[m]=v}if(di!=null){days[di].isHoliday=hol?true:false;days[di].grid=arr;applyDayVisual(di)}}}
function packLetters(){const out=[];for(let i=0;i<days.length;i++){const L=days[i].letters;if(L.some(x=>x&&x.length)){out.push(...ve(i));for(let k=0;k<6;k++){const c=L[k]?L[k].charCodeAt(0)&255:0;out.push(c)}}}return new Uint8Array(out)}
function unpackLetters(U,start){let i=0;const map=new Map();for(let j=0;j<days.length;j++)map.set(epochDays(days[j].date)-start,j);while(i<U.length){let off;[off,i]=vd(U,i);const di=map.get(off);for(let k=0;k<6;k++){const c=U[i++];if(di!=null){days[di].letters[k]=c?String.fromCharCode(c):'';const mini=dayEls[di].querySelectorAll('.mini')[k];applyMiniLetter(mini,days[di].letters[k])}}}}
function exportState(){return new Promise(async(res,rej)=>{try{const daysB=packDays();const lettersB=packLetters();const start=epochDays(days[0].date);const barr=[...barriers].sort((a,b)=>a-b).map(p=>p-1);const terms=[...barrierBoxes.entries()].map(([pos,b])=>({o:pos-1,t:b.title||'',c:!!b.closed}));const notes=[...notesBoxes.entries()].map(([id,b])=>{const r=b.el.getBoundingClientRect(),wr=wrap.getBoundingClientRect();return{t:b.title||'',b:b.el.querySelector('.note-content').textContent||'',x:Math.round(r.left-wr.left),y:Math.round(r.top-wr.top),w:Math.round(r.width),h:Math.round(r.height),c:!!b.closed}});const def=Object.fromEntries(COLORS.map(c=>[c.key,c.name]));const lab={};for(const k in colorLabels){if(colorLabels[k]!==def[k])lab[k]=colorLabels[k]}const b64days=b64(daysB),b64letters=b64(lettersB),b64bars=btoa(JSON.stringify(barr)),b64terms=btoa(JSON.stringify(terms));let hdr='V1',b64notes;try{if('CompressionStream'in window&&notes.length){const json=JSON.stringify(notes);const cs=new CompressionStream('gzip');const stream=new Blob([json]).stream().pipeThrough(cs);const buf=await new Response(stream).arrayBuffer();b64notes=b64(new Uint8Array(buf));hdr='V1Z'}else{b64notes=btoa(JSON.stringify(notes))}}catch{b64notes=btoa(JSON.stringify(notes))}const out=[hdr,b64days,b64letters,b64bars,b64terms,b64notes,JSON.stringify(lab)].join('|');res(out)}catch(e){rej(e)}})}
function clearAll(){closeAllBoxes();removeAllBarriers();resetMinisInRange(0,days.length-1);for(const [,n] of notesBoxes){n.el.remove()}notesBoxes.clear();}
function importState(str){return new Promise(async(res,rej)=>{try{clearAll();const parts=str.split('|');if(parts.length<6)throw 'Bad code';const hdr=parts[0],Udays=ub64(parts[1]);unpackDays(Udays);const [start]=vd(Udays,0);const Ulet=ub64(parts[2]);unpackLetters(Ulet,start);const bars=JSON.parse(atob(parts[3]));for(const off of bars){const ep=start+off;const idx=days.findIndex(d=>epochDays(d.date)===ep);if(idx>=0){const pos=idx+1;if(!barriers.has(pos))toggleBarrier(pos)}}const terms=JSON.parse(atob(parts[4]));for(const t of terms){const idx=days.findIndex(d=>epochDays(d.date)===(start+(t.o||0)));if(idx>=0){const pos=idx+1;const b=barrierBoxes.get(pos);if(b){b.title=t.t||'';b.closed=!!t.c;b.el.querySelector('.box-title').textContent=b.title;if(b.closed)b.el.style.display='none';else b.el.style.display='';}}}
let notesArr=[];if(hdr==='V1Z'&&('DecompressionStream'in window)){const U=ub64(parts[5]);const ds=new DecompressionStream('gzip');const stream=new Blob([U]).stream().pipeThrough(ds);const txt=await new Response(stream).text();notesArr=JSON.parse(txt)}else{notesArr=JSON.parse(atob(parts[5]))}
for(const n of notesArr){const id=noteSeq++;const box=createNoteBox(id);notesBoxes.set(id,box);box.title=n.t||'';box.el.querySelector('.box-title').textContent=box.title;box.el.querySelector('.note-content').textContent=n.b||'';if(n.c){box.closed=true;box.el.style.display='none'}if(n.x!=null){box.el.style.left=n.x+'px'}if(n.y!=null){box.el.style.top=n.y+'px'}if(n.w!=null){box.el.style.width=n.w+'px'}if(n.h!=null){box.el.style.height=n.h+'px'}}
if(parts[6]){try{const labs=JSON.parse(parts[6]);for(const k in labs)colorLabels[k]=labs[k]}catch{}}
refreshTermsLegend();refreshNotesLegend();recalcAllBoxes();syncAllGlimmers();res()}catch(e){rej(e)}})}

document.getElementById('notesLegend').addEventListener('click',e=>{
  const chip=e.target.closest('.note-chip');if(!chip)return;
  const id=+chip.dataset.noteId,b=notesBoxes.get(id);if(!b)return;
  if(e.shiftKey){deleteNote(id);return}
  if(b.el.style.display==='none'||b.closed){b.el.style.display='';b.closed=false}
  else {b.el.style.display='none';b.closed=true}
});

// helper funcs needed by ESC and legends
function closeAllBoxes(){for(const [,b] of barrierBoxes){if(b.focusOn) clearFocus(); b.el.style.display='none'; b.closed=true;} for(const [,n] of notesBoxes){n.el.style.display='none'; n.closed=true;}}
function anyMiniColoredOrTyped(){const blank=COLORS.findIndex(c=>c.key==='blank'); for(const d of days){for(let i=0;i<6;i++){if(d.grid[i]!==blank) return true; if(d.letters[i]) return true;}} return false;}
function resetMinisInRange(a,b){
  const blank=COLORS.findIndex(c=>c.key==='blank');
  for(let i=a;i<=b;i++){
    days[i].grid=[blank,blank,blank,blank,blank,blank];
    days[i].letters=["","","","","",""];
    days[i].isHoliday=false;
    const el=dayEls[i];
    if(el){
      el.classList.remove('holiday');
      const minis=el.querySelectorAll('.mini');
      minis.forEach(m=>{applyMiniColor(m,blank);applyMiniLetter(m,'');});
    }
  }
  recalcAllBoxes();
}
function removeAllBarriers(){clearFocus(); for(const pos of [...barriers]){barriers.delete(pos); updateDayBorders(pos); const bx=barrierBoxes.get(pos); if(bx){bx.el.remove(); barrierBoxes.delete(pos);} } refreshTermsLegend();}

function syncAllGlimmers(){const elapsed=(performance.now()-glimmerBase)/1000;const phase=-(elapsed%GLIMMER_PERIOD);const els=document.querySelectorAll('.day.holiday');els.forEach(el=>{el.style.setProperty('--glimmer-phase',phase+'s');});const gbar=document.getElementById('globalBar');if(gbar&&gbar.classList.contains('open')){gbar.style.setProperty('--glimmer-phase',phase+'s');}const useAlt=glimmerFlip;els.forEach(el=>{el.classList.toggle('sync2',useAlt);});if(gbar&&gbar.classList.contains('open'))gbar.classList.toggle('sync2',useAlt);glimmerFlip=!glimmerFlip;}

// init
buildDays(); buildMonthShells(); renderDayCells(); buildGlobalWeek(); refreshTermsLegend(); refreshNotesLegend(); syncAllGlimmers();
shownStartIdx=shownEndIdx=monthOrder.indexOf(INITIAL_KEY);
monthOrder.forEach((key,idx)=>{const sec=monthSections.get(key);const show=(idx>=shownStartIdx&&idx<=shownEndIdx);sec.style.display=show?'':'none';if(show)sec.classList.add('expanded');});
prevMonthBtn=document.getElementById('prevMonthBtn');
nextMonthBtn=document.getElementById('nextMonthBtn');
updateMonthButtons();
updateMonthClosers();
// handlers
const termsLegend=document.getElementById('termsLegend'); if(termsLegend){termsLegend.addEventListener('click',e=>{const chip=e.target.closest('.term-chip'); if(!chip) return; const pos=+chip.dataset.pos; const b=barrierBoxes.get(pos); if(!b) return; if(b.el.style.display==='none'||b.closed){b.el.style.display=''; b.closed=false; positionBox(pos);} else { if(b.focusOn) clearFocus(); b.el.style.display='none'; b.closed=true; }});}
const addNoteBtn=document.getElementById('addNoteBtn'); if(addNoteBtn){addNoteBtn.addEventListener('click',()=>{const id=noteSeq++; const box=createNoteBox(id); notesBoxes.set(id,box); refreshNotesLegend();});}
const themeToggle=document.getElementById('themeToggle'); if(themeToggle){themeToggle.addEventListener('click',()=>{document.documentElement.classList.toggle('light'); syncAllGlimmers();});}
const ieToggle=document.getElementById('ieToggle'); if(ieToggle){ieToggle.addEventListener('click',()=>{if(ieEl){ieEl.style.display=(ieEl.style.display==='none')?'':'none';} else createIE();});}
const termsTxtBtn=document.getElementById('termsTxtBtn'); if(termsTxtBtn){termsTxtBtn.addEventListener('click',()=>{const txt=buildTermsReport();downloadTxt('terms-report.txt',txt)});}
if(prevMonthBtn)prevMonthBtn.addEventListener('click',showPrevMonth);
if(nextMonthBtn)nextMonthBtn.addEventListener('click',showNextMonth);
const globalToggle=document.getElementById('globalToggle');const globalBar=document.getElementById('globalBar');if(globalToggle&&globalBar){globalToggle.addEventListener('click',()=>{const show=!globalBar.classList.contains('open');if(show){globalBar.classList.add('open');}else{globalBar.classList.remove('open');}globalToggle.textContent=show?'Hide global':'Global';syncAllGlimmers();});}

// esc logic + typing helper
function isEditingTarget(el){return el&&(el.isContentEditable||el.tagName==='INPUT'||el.tagName==='TEXTAREA')}
window.addEventListener('keydown',e=>{if(e.key&&e.key.toLowerCase()==='t'&&!e.repeat&&!isEditingTarget(e.target))tHeld=true});
window.addEventListener('keyup',e=>{if(e.key&&e.key.toLowerCase()==='t')tHeld=false});
window.addEventListener('keydown',e=>{if(e.key==='Escape'&&e.shiftKey){resetGlobalTemplate();buildGlobalWeek();return}if(e.key!=='Escape')return; if(activeFocusPos!=null){const {start,end}=segmentFor(activeFocusPos);resetMinisInRange(start,end);return} const anyOpenTerms=[...barrierBoxes.values()].some(b=>b.el.style.display!=='none'&&!b.closed); const anyOpenNotes=[...notesBoxes.values()].some(n=>n.el.style.display!=='none'&&!n.closed); if(anyOpenTerms||anyOpenNotes){closeAllBoxes();return} if(anyMiniColoredOrTyped()){resetMinisInRange(0,days.length-1);return} if(barriers.size>0){removeAllBarriers();return} if(notesBoxes.size===0&&barriers.size===0&&!anyMiniColoredOrTyped()&&!globalTemplateEmpty()){resetGlobalTemplate();buildGlobalWeek();return}});

// keep boxes positioned
window.addEventListener('resize',()=>{for(const [pos] of barrierBoxes)positionBox(pos)});
})();
</script>
</body>
</html>
