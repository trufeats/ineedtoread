<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Student Picker</title>
<style>
/* Basic layout and typography */
body{margin:0;font-family:'Segoe UI',sans-serif;display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:linear-gradient(-45deg,#1a2a6c,#b21f1f,#fdbb2d,#1a2a6c);background-size:400% 400%;animation:cosmic 20s ease infinite;}
button{cursor:pointer;border:none;padding:10px 20px;font-size:1rem;border-radius:4px;transition:background 0.3s;}
button:hover{background:#eee;}
#pickBtn{font-size:1.5rem;padding:20px 40px;margin-top:20px;}
#gameTitle{position:fixed;top:10px;left:50%;transform:translateX(-50%);margin:0;font-size:2rem;cursor:text;}
#result{margin-top:20px;min-height:6rem;}
#result .picked{font-size:6rem;animation:pop 0.6s ease forwards;opacity:0;}
#countdown{margin-top:10px;font-size:1.2rem;}

/* Top buttons */
.top-btn{position:fixed;top:10px;background:transparent;border:none;font-size:1.5rem;}
#dataToggle{left:10px;}
#settingsToggle{right:10px;}

/* Popups */
.popup{position:fixed;background:#fff;border:1px solid #ccc;border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,0.2);padding:0;}
.popup.hidden{display:none;}
.popup-header{background:#f0f0f0;padding:5px 10px;cursor:move;display:flex;justify-content:space-between;align-items:center;border-top-left-radius:6px;border-top-right-radius:6px;}
.popup-header span{cursor:pointer;}
.popup-content{padding:10px;}
#dataArea{width:250px;height:120px;}
.popup-actions{display:flex;gap:10px;margin-top:10px;}

/* Overlays */
.overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:flex;align-items:center;justify-content:center;}
.overlay.hidden{display:none;}
.overlay .content{background:#fff;border-radius:8px;padding:20px;min-width:260px;max-height:90%;overflow:auto;position:relative;}
.overlay .content .close{position:absolute;top:10px;right:10px;cursor:pointer;}

/* Settings layout */
#settingsBox label{display:block;margin:10px 0 5px;}

/* Student list overlay */
#studentOverlay .columns{display:flex;gap:20px;}
#studentOverlay .column{min-width:150px;}
#studentOverlay .column.male .name{font-size:4.8rem;background:rgba(30,144,255,0.2);position:relative;overflow:hidden;}
#studentOverlay .column.female .name{font-size:4.8rem;background:rgba(255,0,255,0.2);position:relative;overflow:hidden;}
#studentOverlay .column.unknown{font-size:0.9rem;text-align:center;}
#studentOverlay .column.unknown .name{background:rgba(80,80,80,0.2);}
#studentOverlay .name{padding:5px;border-radius:4px;margin:2px 0;cursor:pointer;transition:background 0.3s;}
#studentOverlay .name:hover{background:#eee;}
#studentOverlay .name.inactive{color:#888;}
#studentOverlay .name .mult{font-size:0.5em;margin-left:8px;}
#studentInput{width:100%;margin-top:10px;padding:8px;}

/* End overlay */
#endOverlay .content{background:#fff;padding:40px;border-radius:8px;text-align:center;}

/* Info overlay */
#infoBox ul{list-style:none;padding-left:0;}
#infoBox li{margin:5px 0;}

/* Animations */
@keyframes shine{from{left:-100%;}to{left:100%;}}
@keyframes pop{from{opacity:0;transform:scale(0.5);}to{opacity:1;transform:scale(1);}}
@keyframes cosmic{0%{background-position:0% 50%;}50%{background-position:100% 50%;}100%{background-position:0% 50%;}}
.firework{position:fixed;pointer-events:none;}
.firework span{position:absolute;width:8px;height:8px;border-radius:50%;background:gold;animation:particle 600ms ease-out forwards;}
@keyframes particle{from{transform:translate(0,0);opacity:1;}to{transform:translate(var(--x),var(--y));opacity:0;}}

#studentOverlay .column.male .name::after,
#studentOverlay .column.female .name::after{content:'';position:absolute;top:0;left:-100%;width:100%;height:100%;background:linear-gradient(120deg,transparent,rgba(255,255,255,0.5),transparent);animation:shine 4s linear infinite;}
#studentOverlay .name.used{color:#000;text-decoration:line-through;}
#studentOverlay .name.used::after{display:none;}

</style>
</head>
<body>
<button id="dataToggle" class="top-btn">☰</button>
<button id="settingsToggle" class="top-btn">⚙️</button>
<h1 id="gameTitle" contenteditable="true">Class</h1>
<div id="result"></div>
<button id="pickBtn">Pick Student</button>
<div id="countdown"></div>

<!-- Import/Export Popup -->
<div id="dataBox" class="popup hidden" style="top:60px;left:20px;">
  <div class="popup-header" id="dataHeader">Data <span id="dataClose">✖</span></div>
  <div class="popup-content">
    <textarea id="dataArea" placeholder="Paste data here"></textarea>
    <div class="popup-actions">
      <button id="importBtn">Import</button>
      <button id="exportBtn">Export</button>
    </div>
  </div>
</div>

<!-- Settings Overlay -->
<div id="settingsBox" class="overlay hidden">
  <div class="content">
    <span class="close" id="settingsClose">✖</span>
    <h2>Settings</h2>
    <label>Gender</label>
    <select id="genderSetting">
      <option value="r">Random</option>
      <option value="m">Male</option>
      <option value="f">Female</option>
    </select>
    <label>Selection Mode</label>
    <select id="modeSetting">
      <option value="random">True Random</option>
      <option value="noRecent">No last 3 picks</option>
      <option value="noRepeat">No repeats</option>
    </select>
    <label>Count</label>
    <select id="countSetting">
      <option value="1">1</option>
      <option value="2">2</option>
      <option value="3">3</option>
    </select>
  </div>
</div>

<!-- Student Overlay -->
<div id="studentOverlay" class="overlay hidden">
  <div class="content">
    <span class="close" id="studentClose">✖</span>
    <div class="columns">
      <div id="maleList" class="column male"></div>
      <div id="unknownList" class="column unknown"></div>
      <div id="femaleList" class="column female"></div>
    </div>
    <input id="studentInput" placeholder="Type name and press Enter"/>
  </div>
</div>

<!-- End Overlay -->
<div id="endOverlay" class="overlay hidden">
  <div class="content">
    <h2>All students have been picked!</h2>
    <button id="resetBtn">Reset</button>
  </div>
</div>

<!-- Controls Overlay -->
<div id="infoBox" class="overlay hidden">
  <div class="content">
    <span class="close" id="infoClose">✖</span>
    <h2>Controls</h2>
    <ul>
      <li>q: settings</li>
      <li>space: student list</li>
      <li>m/f/r: pick gender</li>
      <li>1/2/3: pick count</li>
      <li>, and .: history</li>
      <li>/: soft reset</li>
      <li>?: hard reset</li>
      <li>i: controls</li>
    </ul>
  </div>
</div>

<script>
// Data structures
let students=[]; // {name, gender, weight, disabled}
let settings={gender:'r', mode:'random', count:1};
let history=[]; // array of arrays
let historyIndex=-1;
let recent=[]; // last picks for noRecent
let remaining=[]; // for noRepeat mode
let usedCounts={}; // times each student has been used
let modifier=null; // for student overlay
let forcedQueue=[]; // scheduled picks

const result=document.getElementById('result');
const pickBtn=document.getElementById('pickBtn');
const genderSetting=document.getElementById('genderSetting');
const modeSetting=document.getElementById('modeSetting');
const countSetting=document.getElementById('countSetting');
const countdown=document.getElementById('countdown');
const gameTitle=document.getElementById('gameTitle');

// Import/Export popup
const dataBox=document.getElementById('dataBox');
const dataToggle=document.getElementById('dataToggle');
const dataClose=document.getElementById('dataClose');
const importBtn=document.getElementById('importBtn');
const exportBtn=document.getElementById('exportBtn');
const dataArea=document.getElementById('dataArea');
const dataHeader=document.getElementById('dataHeader');
let dragOffset={x:0,y:0};
let dragging=false;

// Settings overlay
const settingsBox=document.getElementById('settingsBox');
const settingsToggle=document.getElementById('settingsToggle');
const settingsClose=document.getElementById('settingsClose');

// Student overlay
const studentOverlay=document.getElementById('studentOverlay');
const studentClose=document.getElementById('studentClose');
const maleList=document.getElementById('maleList');
const femaleList=document.getElementById('femaleList');
const unknownList=document.getElementById('unknownList');
const studentInput=document.getElementById('studentInput');

// End overlay
const endOverlay=document.getElementById('endOverlay');
const resetBtn=document.getElementById('resetBtn');

// Info overlay
const infoBox=document.getElementById('infoBox');
const infoClose=document.getElementById('infoClose');

function toggle(el){el.classList.toggle('hidden');}

function buildRemaining(){
  remaining=[];
  students.forEach(s=>{
    if(s.disabled) return;
    const w=s.weight||1;
    const u=usedCounts[s.name]||0;
    for(let i=u;i<w;i++) remaining.push(s);
  });
}

function softReset(){
  history=[];
  historyIndex=-1;
  recent=[];
  usedCounts={};
  buildRemaining();
  result.innerHTML='';
  endOverlay.classList.add('hidden');
  countdown.textContent=settings.mode==='noRepeat'?`Remaining: ${remaining.length}`:'';
  forcedQueue=[];
  markUsed();
}

function hardReset(){
  students=[];
  renderStudents();
  softReset();
}

// Dragging for data box
dataHeader.addEventListener('mousedown',e=>{dragging=true;dragOffset.x=e.offsetX;dragOffset.y=e.offsetY;});
document.addEventListener('mousemove',e=>{if(dragging){dataBox.style.left=(e.pageX-dragOffset.x)+'px';dataBox.style.top=(e.pageY-dragOffset.y)+'px';}});
document.addEventListener('mouseup',()=>dragging=false);

// Import / Export
dataToggle.addEventListener('click',()=>{dataBox.classList.toggle('hidden');});
dataClose.addEventListener('mousedown',e=>e.stopPropagation());
dataClose.addEventListener('click',e=>{e.stopPropagation();dataBox.classList.add('hidden');dragging=false;});
importBtn.addEventListener('click',()=>{try{const text=dataArea.value.trim();const [title,rest]=text.split('|');gameTitle.textContent=title||'Class';students=rest?rest.split(',').filter(Boolean).map(p=>{const [n,g]=p.split(':');return {name:n,gender:(g||'u'),weight:1,disabled:false};}):[];renderStudents();softReset();dataBox.classList.add('hidden');}catch(e){alert('Invalid data');}});
exportBtn.addEventListener('click',()=>{const title=gameTitle.textContent.trim()||'Class';const data=students.map(s=>`${s.name}:${s.gender}`).join(',');dataArea.value=`${title}|${data}`;dataArea.select();document.execCommand('copy');});

// Settings controls
settingsToggle.addEventListener('click',()=>toggle(settingsBox));
settingsClose.addEventListener('click',()=>settingsBox.classList.add('hidden'));

genderSetting.addEventListener('change',()=>settings.gender=genderSetting.value);
modeSetting.addEventListener('change',()=>{
  settings.mode=modeSetting.value;
  if(settings.mode==='noRepeat'){
    buildRemaining();
    countdown.textContent=`Remaining: ${remaining.length}`;
  }else{
    countdown.textContent='';
  }
  markUsed();
});
countSetting.addEventListener('change',()=>settings.count=parseInt(countSetting.value));

// Student overlay functions
function markUsed(){
  document.querySelectorAll('#studentOverlay .name').forEach(el=>{
    const stu=students.find(s=>s.name===el.dataset.name);
    if(stu && stu.disabled){
      el.classList.remove('used');
    }else{
      const used=usedCounts[stu.name]||0;
      if(settings.mode==='noRepeat' && used>=(stu.weight||1)){
        el.classList.add('used');
      }else{
        el.classList.remove('used');
      }
    }
  });
}

function spawnFirework(e){
  const fw=document.createElement('div');
  fw.className='firework';
  fw.style.left=e.clientX+'px';
  fw.style.top=e.clientY+'px';
  const parts=20;
  for(let i=0;i<parts;i++){
    const s=document.createElement('span');
    const angle=(i/parts)*Math.PI*2;
    const dist=200;
    s.style.setProperty('--x',Math.cos(angle)*dist+'px');
    s.style.setProperty('--y',Math.sin(angle)*dist+'px');
    s.style.background=`hsl(${Math.random()*360},100%,70%)`;
    fw.appendChild(s);
  }
  document.body.appendChild(fw);
  setTimeout(()=>fw.remove(),600);
}

function renderStudents(){
  const males=students.filter(s=>s.gender==='m').sort((a,b)=>a.name.localeCompare(b.name));
  const females=students.filter(s=>s.gender==='f').sort((a,b)=>a.name.localeCompare(b.name));
  const unknowns=students.filter(s=>s.gender==='u').sort((a,b)=>a.name.localeCompare(b.name));
  const tmpl=s=>`<div class="name${s.disabled?' inactive':''}" data-name="${s.name}">${s.name}${s.weight!==1?`<span class="mult">x${s.weight}</span>`:''}</div>`;
  maleList.innerHTML=males.map(tmpl).join('');
  femaleList.innerHTML=females.map(tmpl).join('');
  unknownList.innerHTML=unknowns.map(tmpl).join('');
  if(settings.mode==='noRepeat') buildRemaining();
  markUsed();
  if(settings.mode==='noRepeat') countdown.textContent=`Remaining: ${remaining.length}`;
}

studentInput.addEventListener('keydown',e=>{
  if(e.key==='Enter' && studentInput.value.trim()){
    students.push({name:studentInput.value.trim(),gender:'u',weight:1,disabled:false});studentInput.value='';renderStudents();
  }
});

studentOverlay.addEventListener('click',e=>{
  const target=e.target;
  if(target.classList.contains('name')){
    const name=target.dataset.name;
    const idx=students.findIndex(s=>s.name===name);
    if(e.shiftKey){
      students[idx].disabled=!students[idx].disabled;
    }else if(modifier==='f') students[idx].gender='f';
    else if(modifier==='m') students[idx].gender='m';
    else if(modifier && /^\d$/.test(modifier)) students[idx].weight=parseInt(modifier);
    else students.splice(idx,1);
    renderStudents();
  }
});

studentClose.addEventListener('click',()=>{studentOverlay.classList.add('hidden');modifier=null;});
infoClose.addEventListener('click',()=>infoBox.classList.add('hidden'));

// Show overlays and handle keys
document.addEventListener('keydown',e=>{
  if(e.key==='Escape'){settingsBox.classList.add('hidden');studentOverlay.classList.add('hidden');dataBox.classList.add('hidden');infoBox.classList.add('hidden');modifier=null;}
  if(!studentOverlay.classList.contains('hidden') && (e.key==='f'||e.key==='m'||/^\d$/.test(e.key))) modifier=e.key;
  if(e.target.tagName==='INPUT' || e.target.tagName==='TEXTAREA' || e.target.isContentEditable) return;
  if(e.key==='q'){toggle(settingsBox);}
  else if(e.key===' '){e.preventDefault();studentOverlay.classList.remove('hidden');studentInput.focus();}
  else if(e.key===','){if(history.length){historyIndex=Math.max(0,historyIndex-1);result.innerHTML=history[historyIndex].map(n=>`<div class="picked">${n}</div>`).join('');}}
  else if(e.key==='.') {if(history.length){historyIndex=Math.min(history.length-1,historyIndex+1);result.innerHTML=history[historyIndex].map(n=>`<div class="picked">${n}</div>`).join('');}}
  else if(e.key==='/'){softReset();}
  else if(e.key==='?'){hardReset();}
  else if(e.key==='i'){toggle(infoBox);}
  else if(['m','f','r','1','2','3'].includes(e.key) && settingsBox.classList.contains('hidden') && studentOverlay.classList.contains('hidden')){
    if(e.key==='m') performPick('m',null);
    if(e.key==='f') performPick('f',null);
    if(e.key==='r') performPick('r',null);
    if(e.key==='1') performPick(null,1);
    if(e.key==='2') performPick(null,2);
    if(e.key==='3') performPick(null,3);
  }
});


pickBtn.addEventListener('click',e=>{
  if(e.shiftKey){
    const last=result.querySelector('.picked');
    if(last){
      const name=last.textContent;
      let rounds=3;
      if(settings.mode==='noRepeat'){
        const roundsAvail=Math.ceil(Math.max(1,remaining.length)/settings.count);
        rounds=Math.min(3,Math.max(1,roundsAvail-1));
      }
      forcedQueue.push({name,rounds});
    }
    spawnFirework(e);
  }
  performPick();
});

function performPick(tempGender=null,tempCount=null){
  if(!students.length){result.textContent='No students';return;}
  forcedQueue.forEach(f=>f.rounds--);
  const due=forcedQueue.filter(f=>f.rounds<=0).map(f=>f.name);
  forcedQueue=forcedQueue.filter(f=>f.rounds>0);
  let gender=tempGender||settings.gender;
  let count=tempCount||settings.count;
  let pick=[];
  const zeros=students.filter(s=>s.weight===0 && !s.disabled);
  let pool=students.filter(s=>{
    if(s.disabled) return false;
    if(gender==='m' && s.gender!=='m') return false;
    if(gender==='f' && s.gender!=='f') return false;
    return true;
  });
  if(settings.mode==='noRecent'){
    pool=pool.filter(s=>!recent.includes(s.name));
    if(!pool.length) pool=students.filter(s=>{
      if(s.disabled) return false;
      if(gender==='m' && s.gender!=='m') return false;
      if(gender==='f' && s.gender!=='f') return false;
      return true;
    });
  }
  if(settings.mode==='noRepeat'){
    if(!remaining.length) {endOverlay.classList.remove('hidden');return;}
    pool=remaining.filter(s=>{
      if(gender==='m') return s.gender==='m';
      if(gender==='f') return s.gender==='f';
      return true;
    });
    if(!pool.length){result.textContent='No matching students';return;}
  }
  pool=pool.filter(s=>!due.includes(s.name) && s.weight!==0);
  let weighted=[];
  if(settings.mode==='noRepeat'){
    weighted=pool.slice();
  }else{
    pool.forEach(s=>{const w=s.weight||1;for(let i=0;i<w;i++) weighted.push(s);});
  }
  due.forEach(name=>{const s=students.find(st=>st.name===name);if(s) pick.push(s);});
  zeros.forEach(z=>{if(!due.includes(z.name) && pick.length<count) pick.push(z);});
  if(!weighted.length && pick.length<count){result.textContent='No matching students';return;}
  for(let i=pick.length;i<count && weighted.length;i++){
    const idx=Math.floor(Math.random()*weighted.length);
    const chosen=weighted[idx];
    pick.push(chosen);
    weighted=weighted.filter(s=>s!==chosen);
  }
  result.innerHTML=pick.map(s=>`<div class="picked">${s.name}</div>`).join('');
  history.push(pick.map(s=>s.name));
  historyIndex=history.length-1;
  recent=recent.concat(pick.map(s=>s.name)).slice(-3);
  if(settings.mode==='noRepeat'){
    pick.forEach(s=>{if(s.weight!==0){usedCounts[s.name]=(usedCounts[s.name]||0)+1;}});
    buildRemaining();
    countdown.textContent=`Remaining: ${remaining.length}`;
    markUsed();
    if(!remaining.length) endOverlay.classList.remove('hidden');
  }
}

resetBtn.addEventListener('click',()=>{buildRemaining();endOverlay.classList.add('hidden');countdown.textContent=settings.mode==='noRepeat'?`Remaining: ${remaining.length}`:'';markUsed();});
</script>
</body>
</html>
